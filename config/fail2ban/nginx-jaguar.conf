# Fail2ban configuration для JAGUAR FIGHT CLUB
# Защита от брутфорс атак на nginx

[Definition]

# Read common prefixes. If any customizations are available -- read them from
# nginx-jaguar-common.local
__prefix_line = <F-MLFFORGET>(?P<__prefix>)(?P<__suffix>)</F-MLFFORGET>

# Matches e.g.
# 192.168.1.1 - - [25/Jan/2023:14:28:24 +0000] "GET /api/auth/login HTTP/1.1" 404 162 "-" "curl/7.68.0"
# 192.168.1.1 - - [25/Jan/2023:14:28:24 +0000] "POST /api/auth/login HTTP/1.1" 401 25 "-" "Mozilla/5.0"

failregex = ^<HOST> -.*"(GET|POST|PUT|DELETE) /api/auth/login HTTP.*" (401|403|404|429) .*$
            ^<HOST> -.*"(GET|POST|PUT|DELETE) /api/auth/register HTTP.*" (401|403|404|429) .*$
            ^<HOST> -.*"(GET|POST) /webhook.*" (401|403|404|429) .*$
            ^<HOST> -.*".*" (444|400) .*$

# Ignore successful logins
ignoreregex = ^<HOST> -.*"(GET|POST) /api/auth/login HTTP.*" (200|201) .*$
              ^<HOST> -.*"(GET|POST) /api/test HTTP.*" (200|201) .*$

# Date pattern
datepattern = \[%%d/%%b/%%Y:%%H:%%M:%%S %%z\]

[nginx-jaguar]

# Enable jail
enabled  = true

# Port to ban
port     = http,https

# Log file path
logpath  = /var/log/nginx/jaguar_access.log
           /var/log/nginx/jaguar_error.log

# Maximum retry attempts
maxretry = 5

# Time window for attempts
findtime = 600

# Ban duration in seconds (30 minutes)
bantime  = 1800

# Backend
backend = auto

# Chain for iptables
chain = INPUT

# Action to take when IP is banned
action = iptables-multiport[name=nginx-jaguar, port="http,https", protocol=tcp]
         sendmail-whois[name=nginx-jaguar, dest=admin@YOUR_DOMAIN.COM]